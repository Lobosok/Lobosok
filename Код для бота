from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters, ConversationHandler, CallbackQueryHandler
import os
import logging
from dotenv import load_dotenv
from db.models import Session, Vacancy, Candidate

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

TOKEN = os.getenv('TELEGRAM_TOKEN')
ADMIN_ID = 6129075812  # –í–∞—à ID –∏–∑ –ª–æ–≥–æ–≤

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
NAME, PHONE, RESUME = range(3)

# –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
def admin_only(func):
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE, *args, **kwargs):
        user = update.effective_user
        if user.id != ADMIN_ID:
            await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return
        return await func(update, context, *args, **kwargs)
    return wrapper

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} ({user.first_name}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.")
    
    keyboard = [
        [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π", callback_data='list_vacancies')],
        [InlineKeyboardButton("üìù –ü–æ–¥–∞—Ç—å —Ä–µ–∑—é–º–µ", callback_data='apply_start')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        f'–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user.first_name}! –Ø HR-–±–æ—Ç. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
        reply_markup=reply_markup
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    if query.data == 'list_vacancies':
        await list_vacancies_inline(update, context)
    elif query.data == 'apply_start':
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π –∞–Ω–∫–µ—Ç—ã –≤—Ä—É—á–Ω—É—é
        await query.message.reply_text("–ù–∞–ø–∏—à–∏—Ç–µ /apply —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã (—Å–∫–æ—Ä–æ —Å–¥–µ–ª–∞–µ–º —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).")

async def list_vacancies_inline(update: Update, context: ContextTypes.DEFAULT_TYPE):
    session = Session()
    vacancies = session.query(Vacancy).all()
    session.close()
    
    if not vacancies:
        await update.callback_query.message.reply_text('–°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π –ø—É—Å—Ç.')
        return
    
    text = "–°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π:\n"
    keyboard = []
    for v in vacancies:
        text += f"- {v.title}\n"
        # –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è" –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
        keyboard.append([InlineKeyboardButton(f"–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ {v.title}", callback_data=f'apply_{v.id}')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.callback_query.message.reply_text(text, reply_markup=reply_markup)

@admin_only
async def add_vacancy(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏: /add_vacancy <–Ω–∞–∑–≤–∞–Ω–∏–µ>')
        return
    
    title = ' '.join(context.args)
    session = Session()
    new_vacancy = Vacancy(title=title)
    session.add(new_vacancy)
    session.commit()
    session.close()
    
    await update.message.reply_text(f'–í–∞–∫–∞–Ω—Å–∏—è "{title}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!')

async def list_vacancies(update: Update, context: ContextTypes.DEFAULT_TYPE):
    session = Session()
    vacancies = session.query(Vacancy).all()
    session.close()
    
    if not vacancies:
        await update.message.reply_text('–°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π –ø—É—Å—Ç.')
        return
    
    text = "–°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π:\n"
    for v in vacancies:
        text += f"- {v.title}\n"
    
    await update.message.reply_text(text)

@admin_only
async def list_candidates(update: Update, context: ContextTypes.DEFAULT_TYPE):
    session = Session()
    candidates = session.query(Candidate).all()
    session.close()
    
    if not candidates:
        await update.message.reply_text('–°–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø—É—Å—Ç.')
        return
    
    text = "–°–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:\n"
    for c in candidates:
        text += f"üë§ {c.name}\nüìû {c.phone}\nüìÑ {c.resume}\n---\n"
    
    await update.message.reply_text(text)

# --- ConversationHandler –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏ ---

async def start_apply(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏—à–µ–ª –ª–∏ –≤—ã–∑–æ–≤ –æ—Ç –∫–Ω–æ–ø–∫–∏ (CallbackQuery) –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–∑ callback_data (–Ω–∞–ø—Ä–∏–º–µ—Ä, apply_1)
        data = query.data
        if data.startswith('apply_'):
            vacancy_id = data.split('_')[1]
            # –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–∑ –ë–î –ø–æ ID, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–º ID
            context.user_data['vacancy_id'] = vacancy_id
            await query.message.reply_text(
                f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –≤–∞–∫–∞–Ω—Å–∏—é (ID: {vacancy_id}).\n"
                "–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –≤–∞—à—É –∞–Ω–∫–µ—Ç—É.\n"
                "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? (–í–≤–µ–¥–∏—Ç–µ –§–ò–û)"
            )
        else:
             await query.message.reply_text(
                "–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –≤–∞—à—É –∞–Ω–∫–µ—Ç—É.\n"
                "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? (–í–≤–µ–¥–∏—Ç–µ –§–ò–û)"
            )
        return NAME

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥–∞–ª –∞—Ä–≥—É–º–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, /apply Python Developer)
    if context.args:
        vacancy_name = ' '.join(context.args)
        context.user_data['vacancy_interest'] = vacancy_name
        await update.message.reply_text(
            f"–í—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é: {vacancy_name}.\n"
            "–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –≤–∞—à—É –∞–Ω–∫–µ—Ç—É.\n"
            "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? (–í–≤–µ–¥–∏—Ç–µ –§–ò–û)"
        )
    else:
        await update.message.reply_text(
            "–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –≤–∞—à—É –∞–Ω–∫–µ—Ç—É.\n"
            "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? (–í–≤–µ–¥–∏—Ç–µ –§–ò–û)"
        )
    return NAME

async def get_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['name'] = update.message.text
    await update.message.reply_text(
        f"–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, {update.message.text}!\n"
        "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞."
    )
    return PHONE

async def get_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['phone'] = update.message.text
    await update.message.reply_text(
        "–°–ø–∞—Å–∏–±–æ. –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤ –æ —Å–µ–±–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–∑—é–º–µ."
    )
    return RESUME

async def get_resume(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['resume'] = update.message.text
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    session = Session()
    new_candidate = Candidate(
        name=context.user_data['name'],
        phone=context.user_data['phone'],
        resume=context.user_data['resume']
    )
    session.add(new_candidate)
    session.commit()
    session.close()
    
    await update.message.reply_text(
        "–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
    )
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ)
    # try:
    #     await context.bot.send_message(
    #         chat_id=ADMIN_ID,
    #         text=f"üîî <b>–ù–æ–≤—ã–π –æ—Ç–∫–ª–∏–∫!</b>\n\n"
    #              f"üë§ <b>–ò–º—è:</b> {context.user_data['name']}\n"
    #              f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {context.user_data['phone']}\n"
    #              f"üìÑ <b>–†–µ–∑—é–º–µ:</b> {context.user_data['resume']}\n"
    #              f"üíº <b>–í–∞–∫–∞–Ω—Å–∏—è:</b> {context.user_data.get('vacancy_interest', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}",
    #         parse_mode='HTML'
    #     )
    # except Exception as e:
    #     logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É: {e}")

    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    return ConversationHandler.END

async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    text = update.message.text
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user.id} ({user.first_name}): {text}")
    await update.message.reply_text(f'–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: {text}\n–Ø –ø–æ–∫–∞ —É—á—É—Å—å, –Ω–æ —Å–∫–æ—Ä–æ —Å–º–æ–≥—É –∏—Å–∫–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤!')

def start_bot():
    if not TOKEN:
        print('TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.')
        return
    app = ApplicationBuilder().token(TOKEN).build()
    
    # Handler –¥–ª—è –∞–Ω–∫–µ—Ç—ã
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler('apply', start_apply),
            MessageHandler(filters.Regex(r'^/apply'), start_apply),
            CallbackQueryHandler(start_apply, pattern='^apply_')
        ],
        states={
            NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_name)],
            PHONE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_phone)],
            RESUME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_resume)],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )
    
    app.add_handler(conv_handler)
    app.add_handler(CommandHandler('start', start))
    app.add_handler(CommandHandler('add_vacancy', add_vacancy))
    app.add_handler(CommandHandler('list_vacancies', list_vacancies))
    app.add_handler(CommandHandler('list_candidates', list_candidates))
    app.add_handler(CallbackQueryHandler(button_handler)) # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), echo))
    
    print('HR Telegram Bot is running (v5 - with Buttons)...')
    app.run_polling()
